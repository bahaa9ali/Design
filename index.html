<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تعديل الصور بالأرقام العربية</title>
<style>
  body { font-family: 'Tahoma', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; }
  #canvas { display:none; } /* لا حاجة للعرض الأساسي */
  .controls { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
  input, select, button { padding: 5px; font-size: 16px; }
  #preview { margin-top: 20px; display: grid; gap: 10px; grid-template-columns: repeat(3, 1fr); }
  #preview img { border: 1px solid #aaa; width: 100%; cursor: grab; }
</style>
</head>
<body>

<h2>تعديل الصور بالأرقام العربية مع معاينة A4</h2>

<div class="controls">
  <input type="file" id="imageInput" accept="image/*">
  <input type="number" id="startNumber" placeholder="الرقم الأول" min="1" value="1">
  <input type="number" id="endNumber" placeholder="الرقم الأخير" min="1" value="10">
  <input type="color" id="colorInput" value="#ff0000">
  <select id="fontSelect">
    <option value="Meri">Meri</option>
    <option value="Arial">Arial</option>
    <option value="Tahoma">Tahoma</option>
  </select>
  <input type="number" id="fontSize" placeholder="حجم الخط" value="40">
  <button id="addNumber">أضف الرقم</button>
  <button id="previewButton">عرض المعاينة</button>
  <button id="printButton">طباعة</button>
</div>

<canvas id="canvas" width="800" height="600"></canvas>
<div id="preview"></div>

<script>
// تحويل الرقم العربي
function toArabicNumber(num){
    const arabicNums = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
    return num.toString().split('').map(d => arabicNums[d]||d).join('');
}

let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let numbers = [];

// تحميل الصورة
document.getElementById('imageInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = event => {
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }
});

// إضافة الرقم الأساسي (موضع افتراضي)
document.getElementById('addNumber').addEventListener('click', () => {
    const color = document.getElementById('colorInput').value;
    const font = document.getElementById('fontSelect').value;
    const size = parseInt(document.getElementById('fontSize').value);
    numbers.push({x: 50, y: 50, color, font, size});
    alert('تم إضافة الرقم. يمكن سحبه في المعاينة بعد عرضها.');
});

// عرض المعاينة
document.getElementById('previewButton').addEventListener('click', () => {
    const start = parseInt(document.getElementById('startNumber').value);
    const end = parseInt(document.getElementById('endNumber').value);
    if(isNaN(start) || isNaN(end) || start > end) return alert("أدخل أرقام صحيحة");

    const previewDiv = document.getElementById('preview');
    previewDiv.innerHTML = '';

    for(let i=start;i<=end;i++){
        let tempCanvas = document.createElement('canvas');
        tempCanvas.width = 250;
        tempCanvas.height = 180;
        let tempCtx = tempCanvas.getContext('2d');

        // نسخة مستقلة من الأرقام لكل صفحة
        let pageNumbers = numbers.map(n => ({...n}));

        function drawPage(){
            tempCtx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
            tempCtx.drawImage(img,0,0,tempCanvas.width,tempCanvas.height);
            pageNumbers.forEach(n=>{
                tempCtx.fillStyle = n.color;
                tempCtx.font = `${n.size}px ${n.font}`;
                tempCtx.fillText(toArabicNumber(i), n.x/800*tempCanvas.width, n.y/600*tempCanvas.height);
            });
        }

        drawPage();

        // تمكين سحب الرقم داخل هذه الصفحة فقط
        let selected = null, offsetX=0, offsetY=0;
        tempCanvas.addEventListener('mousedown', e => {
            const rect = tempCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            selected = null;
            for(let j=pageNumbers.length-1;j>=0;j--){
                let n = pageNumbers[j];
                let width = tempCtx.measureText('0').width;
                let height = n.size;
                let nx = n.x/800*tempCanvas.width;
                let ny = n.y/600*tempCanvas.height;
                if(mx>=nx && mx<=nx+width && my<=ny && my>=ny-height){
                    selected = n;
                    offsetX = mx - nx;
                    offsetY = my - ny;
                    break;
                }
            }
        });
        tempCanvas.addEventListener('mousemove', e => {
            if(selected){
                const rect = tempCanvas.getBoundingClientRect();
                let mx = e.clientX - rect.left;
                let my = e.clientY - rect.top;
                selected.x = (mx - offsetX)/(tempCanvas.width/800);
                selected.y = (my - offsetY)/(tempCanvas.height/600);
                drawPage();
            }
        });
        tempCanvas.addEventListener('mouseup', ()=> selected=null);
        tempCanvas.addEventListener('mouseout', ()=> selected=null);

        // بعد الرسم، نستخدم الصورة النهائية في الطباعة
        tempCanvas.dataset.number = i;

        previewDiv.appendChild(tempCanvas);
    }
});

// طباعة المعاينة
document.getElementById('printButton').addEventListener('click', () => {
    const previewDiv = document.getElementById('preview');
    let printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>الطباعة</title></head><body style="display:flex;flex-wrap:wrap;justify-content:flex-start;">');
    Array.from(previewDiv.children).forEach(c=>{
        printWindow.document.write(`<img src="${c.toDataURL()}" style="margin:5px; width:250px; height:180px;">`);
    });
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
});
</script>

</body>
</html>
