<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تعديل الصور بالأرقام</title>
<style>
  body { font-family: 'Tahoma', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; }
  canvas { border: 1px solid #ccc; margin-top: 10px; cursor: grab; }
  .controls { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
  input, select, button { padding: 5px; font-size: 16px; }
</style>
</head>
<body>

<h2>تطبيق تعديل الصور بالأرقام</h2>

<div class="controls">
  <input type="file" id="imageInput" accept="image/*">
  <input type="number" id="numberInput" placeholder="أدخل الرقم الأول" min="1" value="1">
  <input type="color" id="colorInput" value="#ff0000">
  <select id="fontSelect">
    <option value="Meri">Meri</option>
    <option value="Arial">Arial</option>
    <option value="Tahoma">Tahoma</option>
  </select>
  <input type="number" id="fontSize" placeholder="حجم الخط" value="40">
  <button id="addNumber">أضف الرقم</button>
  <button id="exportPDF">حفظ/طباعة</button>
</div>

<canvas id="canvas" width="800" height="600"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let numbers = [];
let selectedNumber = null;
let offsetX, offsetY;

// تحميل الصورة
document.getElementById('imageInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = event => {
            img.src = event.target.result;
            img.onload = () => draw();
        }
        reader.readAsDataURL(file);
    }
});

// إضافة الرقم
document.getElementById('addNumber').addEventListener('click', () => {
    const num = parseInt(document.getElementById('numberInput').value);
    const color = document.getElementById('colorInput').value;
    const font = document.getElementById('fontSelect').value;
    const size = parseInt(document.getElementById('fontSize').value);
    numbers.push({num, x: 50, y: 50, color, font, size});
    draw();
});

// رسم الصورة والأرقام
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(img.src) ctx.drawImage(img,0,0,canvas.width,canvas.height);
    numbers.forEach(n => {
        ctx.fillStyle = n.color;
        ctx.font = `${n.size}px ${n.font}`;
        ctx.fillText(n.num, n.x, n.y);
    });
}

// سحب الرقم
canvas.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    selectedNumber = null;
    for(let i = numbers.length-1;i>=0;i--){
        let n = numbers[i];
        ctx.font = `${n.size}px ${n.font}`;
        let width = ctx.measureText(n.num).width;
        let height = n.size;
        if(mx >= n.x && mx <= n.x + width && my <= n.y && my >= n.y - height){
            selectedNumber = n;
            offsetX = mx - n.x;
            offsetY = my - n.y;
            break;
        }
    }
});

canvas.addEventListener('mousemove', e => {
    if(selectedNumber){
        const rect = canvas.getBoundingClientRect();
        selectedNumber.x = e.clientX - rect.left - offsetX;
        selectedNumber.y = e.clientY - rect.top - offsetY;
        draw();
    }
});

canvas.addEventListener('mouseup', ()=> selectedNumber=null);
canvas.addEventListener('mouseout', ()=> selectedNumber=null);

// حفظ/طباعة PDF
document.getElementById('exportPDF').addEventListener('click', () => {
    let count = parseInt(prompt("أدخل العدد النهائي للأرقام:"));
    if(isNaN(count) || count < 1) return alert("الرجاء إدخال عدد صحيح أكبر من 0");
    const { jsPDF } = window.jspdf;
    let pdf = new jsPDF({orientation: "landscape", unit:"px", format:"a4"});
    const rowLimit = 3; // عدد الصور في الصف الواحد
    let x = 10, y = 10, imgW = 250, imgH = 180;
    for(let i=1;i<=count;i++){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        numbers.forEach(n => {
            ctx.fillStyle = n.color;
            ctx.font = `${n.size}px ${n.font}`;
            ctx.fillText(i, n.x, n.y); // كل صورة بالرقم الحالي
        });
        let dataURL = canvas.toDataURL("image/png");
        pdf.addImage(dataURL,'PNG', x, y, imgW, imgH);
        x += imgW + 10;
        if(i % rowLimit === 0){
            x = 10;
            y += imgH + 10;
            if(y + imgH > pdf.internal.pageSize.getHeight()){
                pdf.addPage();
                y = 10;
            }
        }
    }
    pdf.save("output.pdf");
});
</script>

</body>
</html>
