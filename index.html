<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شبكة الصور بالأرقام المتسلسلة</title>
<style>
body { font-family: 'Tahoma', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; }
.controls { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
input, select, button, label { padding: 5px; font-size: 16px; }
#preview { margin-top: 20px; width:210mm; height:297mm; border:1px solid #000; position: relative; background:#fff; overflow:hidden; }
#preview canvas { display:block; cursor: grab; }
.slider-group { display:flex; flex-direction:column; align-items:center; margin-top:5px; }
</style>
</head>
<body>

<h2>شبكة الصور بالأرقام المتسلسلة</h2>

<div class="controls">
  <input type="file" id="imageInput" accept="image/*">
  <input type="number" id="startNumber" placeholder="الرقم الأول" value="1" min="1">
  <input type="number" id="columns" placeholder="عدد الأعمدة" value="3" min="1">
  <input type="number" id="rows" placeholder="عدد الصفوف" value="3" min="1">
  <input type="number" id="hSpacing" placeholder="المسافة الأفقية" value="10">
  <input type="number" id="vSpacing" placeholder="المسافة العمودية" value="10">
  <input type="color" id="colorInput" value="#ff0000">
  <select id="fontSelect">
    <option value="Meri">Meri</option>
    <option value="Arial">Arial</option>
    <option value="Tahoma">Tahoma</option>
  </select>
  <input type="number" id="fontSize" placeholder="حجم الرقم" value="40">
  <button id="previewButton">عرض المعاينة</button>
  <button id="printButton">طباعة</button>
</div>

<div class="slider-group">
  <label>تحريك الرقم أفقيًا لجميع النسخ</label>
  <input type="range" id="sliderX" min="-200" max="200" value="0">
</div>
<div class="slider-group">
  <label>تحريك الرقم عموديًا لجميع النسخ</label>
  <input type="range" id="sliderY" min="-200" max="200" value="0">
</div>

<canvas id="canvas" width="800" height="600" style="display:none;"></canvas>
<div id="preview"></div>

<script>
// تحويل الرقم للعربية
function toArabicNumber(num){
    const arabicNums = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
    return num.toString().split('').map(d => arabicNums[d]||d).join('');
}

let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let img = new Image();

let offsetAllX = 0;
let offsetAllY = 0;

document.getElementById('sliderX').addEventListener('input', e => { offsetAllX = parseInt(e.target.value); updatePreview(); });
document.getElementById('sliderY').addEventListener('input', e => { offsetAllY = parseInt(e.target.value); updatePreview(); });

document.getElementById('imageInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = event => { img.src = event.target.result; img.onload = () => updatePreview(); }
        reader.readAsDataURL(file);
    }
});

document.getElementById('colorInput').addEventListener('input', updatePreview);
document.getElementById('fontSelect').addEventListener('change', updatePreview);
document.getElementById('fontSize').addEventListener('input', updatePreview);
document.getElementById('columns').addEventListener('input', updatePreview);
document.getElementById('rows').addEventListener('input', updatePreview);
document.getElementById('hSpacing').addEventListener('input', updatePreview);
document.getElementById('vSpacing').addEventListener('input', updatePreview);
document.getElementById('startNumber').addEventListener('input', updatePreview);
document.getElementById('previewButton').addEventListener('click', updatePreview);

function updatePreview(){
    const startNum = parseInt(document.getElementById('startNumber').value);
    const cols = parseInt(document.getElementById('columns').value);
    const rows = parseInt(document.getElementById('rows').value);
    const hSpace = parseInt(document.getElementById('hSpacing').value);
    const vSpace = parseInt(document.getElementById('vSpacing').value);
    const font = document.getElementById('fontSelect').value;
    const color = document.getElementById('colorInput').value;
    const fontSize = parseInt(document.getElementById('fontSize').value);

    if(!img.src) return;

    const previewDiv = document.getElementById('preview');
    previewDiv.innerHTML = '';

    let number = startNum;

    for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
            let tempCanvas = document.createElement('canvas');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            let tempCtx = tempCanvas.getContext('2d');

            function drawImageNumber(){
                tempCtx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
                tempCtx.drawImage(img,0,0,img.width,img.height);
                tempCtx.fillStyle = color;
                tempCtx.font = `${fontSize}px ${font}`;
                tempCtx.fillText(toArabicNumber(number), offsetAllX, offsetAllY + fontSize);
            }
            drawImageNumber();

            // سحب الرقم داخل كل نسخة
            let selected=false, offsetX=0, offsetY=0;
            tempCanvas.addEventListener('mousedown', e=>{
                const rect = tempCanvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                const width = tempCtx.measureText(toArabicNumber(number)).width;
                const height = fontSize;
                if(mx>=offsetAllX && mx<=offsetAllX+width && my>=offsetAllY && my<=offsetAllY+height){
                    selected=true;
                    offsetX = mx - offsetAllX;
                    offsetY = my - offsetAllY;
                }
            });
            tempCanvas.addEventListener('mousemove', e=>{
                if(selected){
                    const rect = tempCanvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;
                    offsetAllX = mx - offsetX;
                    offsetAllY = my - offsetY;
                    drawImageNumber();
                }
            });
            tempCanvas.addEventListener('mouseup', ()=> selected=false);
            tempCanvas.addEventListener('mouseout', ()=> selected=false);

            let wrapper = document.createElement('div');
            wrapper.style.display='inline-block';
            wrapper.style.marginRight = hSpace+'px';
            wrapper.style.marginBottom = vSpace+'px';
            wrapper.appendChild(tempCanvas);
            previewDiv.appendChild(wrapper);

            number++;
        }
    }
}

// الطباعة
document.getElementById('printButton').addEventListener('click', () => {
    const previewDiv = document.getElementById('preview');
    let printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>الطباعة</title></head><body style="display:flex;flex-wrap:wrap;justify-content:flex-start;margin:0;">');
    Array.from(previewDiv.querySelectorAll('canvas')).forEach(c=>{
        printWindow.document.write(`<img src="${c.toDataURL()}" style="margin-right:10px;margin-bottom:10px;">`);
    });
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
});
</script>

</body>
</html>