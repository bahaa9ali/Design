<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>طباعة ملصقات بعدّاد أرقام – A4</title>
<style>
  :root{
    --cols: 3;           /* عدد الأعمدة في الصفحة */
    --rows: 8;           /* عدد الصفوف في الصفحة (3×8 = 24 مثل الصورة) */
    --gap-mm: 6;         /* المسافة بين الملصقات بالميليميتر */
    --num-x: 50;         /* موضع الرقم أفقياً ٪ */
    --num-y: 20;         /* موضع الرقم عمودياً ٪ */
    --num-size: 26;      /* حجم خط الرقم px */
    --num-color: #000;   /* لون الرقم */
    --shadow-color: #000;/* لون الظل */
    --shadow-blur: 3;    /* شدة الظل px */
  }

  *{box-sizing:border-box}
  body{font-family:system-ui, "Amiri", Tahoma, Arial; background:#f2f4f8; margin:0; padding:16px; color:#222}
  .app{max-width:1200px; margin:auto; background:#fff; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.09); padding:18px}
  h1{margin:0 0 12px; font-size:clamp(20px,3vw,28px)}
  .grid{display:grid; grid-template-columns: 320px 1fr; gap:16px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

  .card{border:1px solid #e6e9ef; border-radius:12px; padding:14px}
  .card h2{font-size:18px; margin:0 0 10px}
  label{font-size:14px; color:#444}
  input[type="number"], input[type="range"], input[type="color"], input[type="text"]{width:100%; padding:10px; margin:6px 0 12px; border:1px solid #dde2ea; border-radius:8px}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
  button{border:0; border-radius:999px; padding:12px 16px; cursor:pointer; font-weight:600}
  .btn-primary{background:linear-gradient(90deg,#6a11cb,#2575fc); color:#fff}
  .btn-ghost{background:#f2f4f8}
  .btn-success{background:linear-gradient(90deg,#1aa34a,#31c26d); color:#fff}
  .btn-danger{background:linear-gradient(90deg,#e74c3c,#c0392b); color:#fff}

  /* معاينة موضع الرقم فوق صورة القالب */
  .template{position:relative; border:1px dashed #c7cfdb; border-radius:10px; overflow:hidden; background:#fafbff}
  .template img{display:block; width:100%; height:auto}
  .tpl-number{position:absolute; left:var(--num-x,% 50); top:var(--num-y,% 20); transform:translate(-50%,-50%); font-weight:700; font-size:calc(var(--num-size, 26) * 1px); color:var(--num-color, #000); text-shadow: var(--shadow-blur, 3)px var(--shadow-blur, 3)px var(--shadow-blur, 3)px var(--shadow-color, #000); cursor:grab; user-select:none; z-index:3}
  .tpl-number:active{cursor:grabbing}

  /* مساحة الطباعة */
  .print-area{border:1px solid #e6e9ef; border-radius:12px; overflow:auto; background:#fff; padding:10px}
  .sheet{width:210mm; height:297mm; margin:auto; background:#fff; position:relative; page-break-after:always; border:1px solid #f0f2f6}
  .labels{display:grid; width:100%; height:100%;
          grid-template-columns: repeat(var(--cols), 1fr);
          grid-template-rows: repeat(var(--rows), 1fr);
          gap: calc(var(--gap-mm) * 1mm); padding: calc(var(--gap-mm) * 1mm)}
  .label{position:relative; border:1px solid #eaeef5; border-radius:6px; overflow:hidden; display:flex; align-items:center; justify-content:center}
  .label img{width:100%; height:100%; object-fit:contain}
  .label .num{position:absolute; left:calc(var(--num-x) * 1%); top:calc(var(--num-y) * 1%);
              transform:translate(-50%,-50%); font-weight:700; font-size:calc(var(--num-size) * 1px);
              color:var(--num-color); text-shadow: var(--shadow-blur)px var(--shadow-blur)px var(--shadow-blur)px var(--shadow-color)}

  .hint{font-size:13px; color:#6b7280; margin-top:6px}

  /* طباعة فعلية */
  @page{ size: A4; margin: 6mm }
  @media print{
    body{background:#fff}
    .no-print, .actions{display:none !important}
    .app{box-shadow:none; padding:0}
    .print-area{border:0; padding:0}
    .sheet{border:0; margin:0; page-break-after:always}
  }
</style>
</head>
<body>
  <div class="app">
    <h1>طباعة ملصقات بعدّاد أرقام (A4 3×8 مثل الصورة)</h1>
    <div class="grid">

      <!-- الإعدادات -->
      <section class="card">
        <h2>١) الصورة والموضع</h2>
        <label>اختر الصورة</label>
        <input type="file" id="file" accept="image/*" />
        <div class="template" id="template" style="aspect-ratio: 4/1">
          <img id="tplImg" alt="معاينة" />
          <div id="tplNumber" class="tpl-number">1</div>
        </div>
        <div class="row">
          <div>
            <label>إزاحة أفقية (٪)</label>
            <input type="range" id="x" min="0" max="100" value="50" />
          </div>
          <div>
            <label>إزاحة رأسية (٪)</label>
            <input type="range" id="y" min="0" max="100" value="20" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>حجم الرقم (px)</label>
            <input type="range" id="size" min="12" max="80" value="26" />
          </div>
          <div>
            <label>لون الرقم</label>
            <input type="color" id="color" value="#000000" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>لون الظل</label>
            <input type="color" id="shadowColor" value="#000000" />
          </div>
          <div>
            <label>قيمة الظل (px)</label>
            <input type="range" id="shadowBlur" min="0" max="10" value="3" />
          </div>
        </div>
        <div class="hint">اسحب الرقم مباشرة فوق الصورة لتحديد مكانه، أو استخدم أشرطة التمرير.</div>
        <hr style="margin:14px 0" />
        <h2>٢) الكمية والتخطيط</h2>
        <div class="row">
          <div>
            <label>عدد الملصقات</label>
            <input type="number" id="count" min="1" value="24" />
          </div>
          <div>
            <label>رقم البداية</label>
            <input type="number" id="start" min="0" value="1" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>عدد الأعمدة في الصفحة</label>
            <input type="number" id="cols" min="1" max="6" value="3" />
          </div>
          <div>
            <label>عدد الصفوف في الصفحة</label>
            <input type="number" id="rows" min="1" max="12" value="8" />
          </div>
        </div>
        <label>المسافة بين الملصقات (مم)</label>
        <input type="range" id="gap" min="0" max="15" value="6" />

        <div class="actions">
          <button id="make" class="btn-primary">معاينة الصفحة</button>
          <button id="print" class="btn-success">طباعة</button>
          <button id="reset" class="btn-danger">إعادة ضبط</button>
        </div>
      </section>

      <!-- المعاينة القابلة للطباعة -->
      <section class="card print-area">
        <h2>معاينة الطباعة</h2>
        <div id="sheets"></div>
        <div class="hint no-print">إذا زاد العدد عن سعة الصفحة (الأعمدة × الصفوف)، سينشأ البرنامج صفحات إضافية تلقائياً.</div>
      </section>
    </div>
  </div>

<script>
  const st = document.documentElement.style;
  const file = document.getElementById('file');
  const tplImg = document.getElementById('tplImg');
  const template = document.getElementById('template');
  const tplNumber = document.getElementById('tplNumber');
  const x = document.getElementById('x');
  const y = document.getElementById('y');
  const size = document.getElementById('size');
  const color = document.getElementById('color');
  const shadowColor = document.getElementById('shadowColor');
  const shadowBlur = document.getElementById('shadowBlur');
  const count = document.getElementById('count');
  const start = document.getElementById('start');
  const cols = document.getElementById('cols');
  const rows = document.getElementById('rows');
  const gap = document.getElementById('gap');
  const makeBtn = document.getElementById('make');
  const printBtn = document.getElementById('print');
  const resetBtn = document.getElementById('reset');
  const sheets = document.getElementById('sheets');

  let imageData = '';
  let dragging = false;
  let startPos = {x:0,y:0};

  // تحميل الصورة + ضبط نسبة العرض إلى الارتفاع لمعاينة القالب
  file.addEventListener('change', e => {
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      imageData = ev.target.result;
      tplImg.src = imageData;
      // استنتاج نسبة الأبعاد
      const tmp = new Image();
      tmp.onload = () => {
        const ar = (tmp.width / tmp.height) || 4/1; // افتراضي لو لم يتوفر
        template.style.aspectRatio = ar;
      };
      tmp.src = imageData;
    };
    reader.readAsDataURL(f);
  });

  // ربط عناصر التحكم بالمتغيرات الجذرية
  function syncCSSVars(){
    st.setProperty('--num-x', x.value);
    st.setProperty('--num-y', y.value);
    st.setProperty('--num-size', size.value);
    st.setProperty('--num-color', color.value);
    st.setProperty('--shadow-color', shadowColor.value);
    st.setProperty('--shadow-blur', shadowBlur.value);
    st.setProperty('--cols', Math.max(1, +cols.value));
    st.setProperty('--rows', Math.max(1, +rows.value));
    st.setProperty('--gap-mm', Math.max(0, +gap.value));
    // تحديث معاينة الرقم
    tplNumber.textContent = start.value || 1;
  }
  [x,y,size,color,shadowColor,shadowBlur,cols,rows,gap,start].forEach(el=>{
    el.addEventListener('input', syncCSSVars);
  });
  syncCSSVars();

  // سحب الرقم داخل القالب (بالنسب المئوية دائماً)
  const pct = (val, total) => Math.max(0, Math.min(100, (val/total)*100));
  template.addEventListener('pointerdown', e => {
    if(!imageData) return; // لا سحب بلا صورة
    dragging = true;
    template.setPointerCapture(e.pointerId);
    startPos = {x: e.clientX, y: e.clientY};
    moveAt(e);
  });
  template.addEventListener('pointermove', e => { if(dragging) moveAt(e); });
  template.addEventListener('pointerup', e => { dragging = false; template.releasePointerCapture(e.pointerId); });

  function moveAt(e){
    const rect = template.getBoundingClientRect();
    const px = pct(e.clientX - rect.left, rect.width);
    const py = pct(e.clientY - rect.top, rect.height);
    x.value = Math.round(px);
    y.value = Math.round(py);
    syncCSSVars();
  }

  // إنشاء صفحات المعاينة/الطباعة
  function buildSheets(){
    if(!imageData){
      alert('الرجاء رفع صورة أولاً');
      return;
    }
    sheets.innerHTML = '';
    const total = Math.max(1, +count.value);
    const begin = +start.value || 1;
    const perPage = (+cols.value) * (+rows.value);
    const pages = Math.ceil(total / perPage);

    for(let p=0; p<pages; p++){
      const sheet = document.createElement('div');
      sheet.className = 'sheet';
      sheet.style.setProperty('--cols', +cols.value);
      sheet.style.setProperty('--rows', +rows.value);
      sheet.style.setProperty('--gap-mm', +gap.value);
      sheet.style.setProperty('--num-x', +x.value);
      sheet.style.setProperty('--num-y', +y.value);
      sheet.style.setProperty('--num-size', +size.value);
      sheet.style.setProperty('--num-color', color.value);
      sheet.style.setProperty('--shadow-color', shadowColor.value);
      sheet.style.setProperty('--shadow-blur', +shadowBlur.value);

      const grid = document.createElement('div');
      grid.className = 'labels';

      for(let i=0; i<perPage; i++){
        const index = p*perPage + i;
        if(index >= total) break;
        const n = begin + index;
        const item = document.createElement('div');
        item.className = 'label';
        const img = document.createElement('img');
        img.src = imageData;
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = n;
        item.appendChild(img);
        item.appendChild(num);
        grid.appendChild(item);
      }
      sheet.appendChild(grid);
      sheets.appendChild(sheet);
    }
  }

  document.getElementById('make').addEventListener('click', buildSheets);
  document.getElementById('print').addEventListener('click', () => { buildSheets(); window.print(); });
  document.getElementById('reset').addEventListener('click', () => { location.reload(); });
</script>
</body>
</html>